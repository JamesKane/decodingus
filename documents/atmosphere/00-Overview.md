# Atmosphere Lexicon Overview

To support the "Atmosphere" integration within the AT Protocol (Bluesky) ecosystem, we define a specific Lexicon (schema) for Genomic Data. This allows `decodingus` to interact with the global network of Personal Data Stores (PDS) using standard XRPC methods, effectively turning genomic metadata into a portable, user-owned record type.

## Namespace

**`com.decodingus.atmosphere`**

This namespace covers the genomic operational data generated by BGS nodes and owned by Citizens.

## Design Principles

1. **Granular Records**: Each logical entity (biosample, sequence run, alignment) is a first-class record with its own AT URI. This enables fine-grained CRUD operations without cascading changes.
2. **Parent-Child References**: Child records reference their parents via AT URI, enabling relationship traversal and cascade operations.
3. **Version Tracking**: Records include metadata for change detection and conflict resolution.
4. **Soft Deletes**: Deletions are non-destructive to preserve scientific lineage.
5. **Consent-Driven Sharing**: Matching and comparison features require explicit consent records.
6. **Edge Computing / Metadata Only**: Raw genomic data (BAM, CRAM, VCF, FASTQ, genotype files) is **never** transmitted to DecodingUs. All analysis is performed locally in the Navigator Workbench. Only computed summaries and metadata flow through the PDS to the AppView.

## Data Flow: What Flows vs What Stays Local

### What Flows to DecodingUs (via PDS)

| Data Type | Purpose | Example Fields |
|:---|:---|:---|
| Haplogroup assignments | Tree placement & refinement | `haplogroupName`, `score`, `lineagePath` |
| Private Y-DNA/mtDNA SNPs | Branch discovery consensus | `privateVariants` array |
| STR marker values | Ancestral reconstruction & TMRCA | `strProfile.markers` |
| Coverage/quality metrics | Sample characterization | `alignmentMetrics` summary |
| Ancestry percentages | Population context | `populationBreakdown.components` |
| File metadata | Provenance tracking | `fileInfo` (name, checksum, size - NOT content) |

### What NEVER Flows to DecodingUs

| Data Type | Stays Where | Notes |
|:---|:---|:---|
| BAM/CRAM files | Local workbench | Aligned sequences |
| VCF files | Local workbench | Only private SNPs shared, not full VCF |
| FASTQ files | Local workbench | Raw reads |
| Genotype chip files | Local workbench | Ancestry computed locally |
| IBD segments | Local workbench | Only confirmed match metadata shared |

**Note on `fileInfo` records**: The `location` field in `fileInfo` is for the user's own reference (local paths, personal cloud storage). DecodingUs does NOT access these locations. The field exists so users can track where their files are stored for their own analysis workflows.

## Document Index

| Document | Contents |
|:---|:---|
| [01-Common-Definitions.md](./01-Common-Definitions.md) | Shared type definitions (`recordMeta`, `fileInfo`, `haplogroupResult`, `variantCall`, etc.) |
| [02-Core-Records.md](./02-Core-Records.md) | `workspace`, `biosample`, `sequencerun`, `alignment`, `project` |
| [03-Genotype-Records.md](./03-Genotype-Records.md) | `genotype`, `imputation` |
| [04-Ancestry-Records.md](./04-Ancestry-Records.md) | `populationBreakdown` |
| [05-STR-Records.md](./05-STR-Records.md) | `strProfile`, `haplogroupAncestralStr` |
| [06-IBD-Matching-Records.md](./06-IBD-Matching-Records.md) | `matchConsent`, `matchList`, `matchRequest` |
| [07-Discovery-Records.md](./07-Discovery-Records.md) | `instrumentObservation` |
| [08-AppView-Lifecycle.md](./08-AppView-Lifecycle.md) | Firehose event handling, schema requirements, conflict resolution |
| [09-Examples.md](./09-Examples.md) | Mock data and CRUD flow examples |

## Record Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 WORKSPACE                                        │
│  at://did:plc:user/com.decodingus.atmosphere.workspace/tid                      │
│                                                                                  │
│  sampleRefs: [...]  ──────────────────┐                                         │
│  projectRefs: [...] ──────────────────┼──┐                                      │
└───────────────────────────────────────┼──┼──────────────────────────────────────┘
                                        │  │
                    ┌───────────────────┘  │
                    ▼                      ▼
┌─────────────────────────────────────┐  ┌─────────────────────────────────────┐
│             BIOSAMPLE               │  │              PROJECT                │
│  at://did/collection/tid            │  │  at://did/collection/tid            │
│                                     │  │                                     │
│  haplogroups: { yDna, mtDna }       │  │  projectName, administrator         │
│  sequenceRunRefs: [...] ────────────┼──│  memberRefs: [...] ─────────────────┤
│  genotypeRefs: [...] ───────────────┼──│                                     │
│  populationBreakdownRef ────────────┼──│                                     │
│  strProfileRef ─────────────────────┼──│                                     │
└─────────────────────────────────────┘  └─────────────────────────────────────┘
          │         │         │
          │         │         └─────────────────────────────────┐
          │         │                                           ▼
          │         │                            ┌─────────────────────────────────┐
          │         │                            │     POPULATION BREAKDOWN        │
          │         │                            │  ancestry components [...]      │
          │         │                            └─────────────────────────────────┘
          │         │
          │         └───────────────────────────────────────────┐
          │                                                     ▼
          │                                      ┌─────────────────────────────────┐
          │                                      │           GENOTYPE              │
          │                                      │  chipType, provider, snpCount   │
          │                                      │  files: [...]                   │
          │                                      │  imputationRef ─────────────────┼───┐
          │                                      └─────────────────────────────────┘   │
          ▼                                                                            ▼
┌─────────────────────────────────┐                           ┌─────────────────────────────────┐
│         SEQUENCE RUN            │                           │          IMPUTATION             │
│  platformName, instrumentId     │                           │  referencePanel, imputedCount   │
│  files: [...]                   │                           └─────────────────────────────────┘
│  alignmentRefs: [...] ──────────┼───┐
└─────────────────────────────────┘   │
          │                           ▼
          │         ┌─────────────────────────────────────┐
          │         │           ALIGNMENT             │
          │         │  referenceBuild, aligner        │
          │         │  files: [...], metrics: {...}   │
          │         └─────────────────────────────────┘
          │
          └─────────────────────────────────┐
                                            ▼
                         ┌─────────────────────────────────┐
                         │    INSTRUMENT OBSERVATION       │
                         │  instrumentId, labName          │
                         │  confidence: KNOWN|INFERRED     │
                         └─────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              STR SUBSYSTEM                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  BIOSAMPLE ──────────► STR PROFILE                                              │
│                         markers: [{ marker, value }]                             │
│                         panels: [Y37, Y111, ...]                                │
│                                                                                  │
│  HAPLOGROUP NODE ────► ANCESTRAL STR                                            │
│                         ancestralMarkers: [{ marker, value, confidence }]       │
│                         branchMutations: [{ from, to }]                         │
│                         tmrcaEstimate: { ybp, confidence }                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            MATCHING SUBSYSTEM                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  BIOSAMPLE ◄───── MATCH CONSENT                                                 │
│      │              (enables matching)                                           │
│      │                                                                          │
│      ├───────────► MATCH LIST                                                   │
│      │              matches: [{ biosampleRef, sharedCm, segments }]             │
│      │                                                                          │
│      └───────────► MATCH REQUEST ◄────────────────────────────────────────┐    │
│                     (from → to, status: PENDING|ACCEPTED)                  │    │
│                                                    │                       │    │
│                                                    └───► OTHER BIOSAMPLE ──┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Integration Strategy

In the "Atmosphere" model, this Lexicon defines the data structures for decentralized, user-owned genomic records:

1. **MVP (Current):** The BGS Node (Rust) constructs a JSON payload matching the `ExternalBiosampleRequest` (a simplified subset of this Lexicon) and pushes it to `decodingus` via REST.
2. **Phase 2 (Hybrid - Kafka):** The BGS Node uses this Lexicon structure (or a derived internal representation) to send messages to Kafka. `decodingus` consumes from Kafka and processes a compatible subset.
3. **Phase 3 (Full Atmosphere - AppView):**
    * The Researcher's Edge App (Java) or the BGS Node (authorized by the user) constructs records fully compliant with this Lexicon.
    * These records are written directly to the User's PDS.
    * `decodingus` (acting as an AppView) subscribes to the ATP Firehose, ingesting these records and indexing them.

## Future Scope Summary

| Record Type | Planning Document | Purpose |
|:---|:---|:---|
| `genotype` | multi-test-type-roadmap.md | Chip/array data support |
| `imputation` | multi-test-type-roadmap.md | Imputed genotype results |
| `populationBreakdown` | ibd-matching-system.md | Ancestry composition |
| `matchConsent` | ibd-matching-system.md | IBD matching opt-in |
| `matchList` | ibd-matching-system.md | IBD match results |
| `matchRequest` | ibd-matching-system.md | Match contact requests |
| `instrumentObservation` | sequencer-lab-inference-system.md | Crowdsourced lab discovery |
| `privateVariants` (in defs) | haplogroup-discovery-system.md | Novel variant tracking |
| `strProfile` | Y-DNA STR Support | Individual Y-STR marker data |
| `haplogroupAncestralStr` | Y-DNA Tree Enhancement | Reconstructed ancestral STR states |
| `haplogroupUpdate` | appview-pds-backfeed-system.md | AppView notification of haplogroup refinement |
| `branchDiscovery` | appview-pds-backfeed-system.md | AppView notification of new branch from private variants |
| `treeVersionUpdate` | appview-pds-backfeed-system.md | AppView notification of haplogroup tree version change |
| `potentialMatchList` | appview-pds-backfeed-system.md | Potential match candidates for user exploration |
| `confirmedMatch` | appview-pds-backfeed-system.md | Stamped match when both parties agree |
| `syncStatus` | appview-pds-backfeed-system.md | Track PDS-AppView synchronization state |
| `updateDigest` | appview-pds-backfeed-system.md | Daily digest of all updates |

## Changelog

| Version | Date | Changes |
|:---|:---|:---|
| 1.0 | 2025-12-05 | Initial design with CRUD-optimized record structure |
| 1.1 | 2025-12-06 | Added future scope records from planning documents |
| 1.2 | 2025-12-07 | Added STR profile and ancestral STR reconstruction records |
| 1.3 | 2025-12-07 | Added backfeed record types for AppView-to-PDS updates |
| 1.4 | 2025-12-07 | Edge computing compliance: Clarified all `files` fields store metadata only |
| 1.5 | 2025-12-09 | Split into multiple focused documents |
