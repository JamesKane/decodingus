@import org.webjars.play.WebJarsUtil
@import models.domain.support.{ContactMessage, MessageStatus}
@(messages: Seq[ContactMessage], statusFilter: Option[MessageStatus], currentPage: Int, totalPages: Int, pageSize: Int)(implicit request: RequestHeader, messagesProvider: Messages, webJarsUtil: WebJarsUtil)

@main(messagesProvider("support.admin.title")) {
    <div class="container py-5">
        <h1 class="mb-4">@messagesProvider("support.admin.heading")</h1>

        @request.flash.get("success").map { msg =>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @msg
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action="@controllers.routes.SupportAdminController.listMessages()" class="row g-3">
                    <div class="col-auto">
                        <label class="col-form-label">@messagesProvider("support.admin.filterStatus")</label>
                    </div>
                    <div class="col-auto">
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="">@messagesProvider("support.admin.allStatuses")</option>
                            @for(status <- Seq(MessageStatus.New, MessageStatus.Read, MessageStatus.Replied, MessageStatus.Closed)) {
                                <option value="@status.value" @if(statusFilter.contains(status)) {selected}>
                                    @messagesProvider(s"support.status.${status.value}")
                                </option>
                            }
                        </select>
                    </div>
                </form>
            </div>
        </div>

        @if(messages.isEmpty) {
            <div class="alert alert-info">@messagesProvider("support.admin.noMessages")</div>
        } else {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>@messagesProvider("support.admin.table.status")</th>
                            <th>@messagesProvider("support.admin.table.from")</th>
                            <th>@messagesProvider("support.admin.table.subject")</th>
                            <th>@messagesProvider("support.admin.table.date")</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(msg <- messages) {
                            <tr class="@if(msg.status == MessageStatus.New) {table-primary}">
                                <td>
                                    <span class="badge @statusBadgeClass(msg.status)">
                                        @messagesProvider(s"support.status.${msg.status.value}")
                                    </span>
                                </td>
                                <td>
                                    @if(msg.userId.isDefined) {
                                        <span class="badge bg-info me-1">@messagesProvider("support.admin.authenticated")</span>
                                    }
                                    @msg.senderName.orElse(msg.userId.map(_ => messagesProvider("support.admin.registeredUser"))).getOrElse("Unknown")
                                </td>
                                <td>@msg.subject</td>
                                <td>@msg.createdAt.toLocalDate</td>
                                <td>
                                    <a href="@controllers.routes.SupportAdminController.viewMessage(msg.id.get)" class="btn btn-sm btn-outline-primary">
                                        @messagesProvider("support.admin.view")
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if(totalPages > 1) {
                <nav>
                    <ul class="pagination justify-content-center">
                        <li class="page-item @if(currentPage <= 1) {disabled}">
                            <a class="page-link" href="@controllers.routes.SupportAdminController.listMessages(statusFilter.map(_.value), currentPage - 1, pageSize)">
                                @messagesProvider("pagination.previous")
                            </a>
                        </li>
                        @for(p <- 1 to totalPages) {
                            <li class="page-item @if(p == currentPage) {active}">
                                <a class="page-link" href="@controllers.routes.SupportAdminController.listMessages(statusFilter.map(_.value), p, pageSize)">@p</a>
                            </li>
                        }
                        <li class="page-item @if(currentPage >= totalPages) {disabled}">
                            <a class="page-link" href="@controllers.routes.SupportAdminController.listMessages(statusFilter.map(_.value), currentPage + 1, pageSize)">
                                @messagesProvider("pagination.next")
                            </a>
                        </li>
                    </ul>
                </nav>
            }
        }
    </div>
}

@statusBadgeClass(status: MessageStatus) = @{
    status match {
        case MessageStatus.New => "bg-primary"
        case MessageStatus.Read => "bg-info"
        case MessageStatus.Replied => "bg-success"
        case MessageStatus.Closed => "bg-secondary"
    }
}
