@import models.domain.genomics.VariantV2
@import play.api.libs.json.JsObject
@(haplogroupId: Int, haplogroupName: String, query: Option[String], variants: Seq[VariantV2])(implicit request: RequestHeader)

@* Helper to extract reference genomes from coordinates *@
@refGenomes(v: VariantV2) = @{
    v.coordinates.asOpt[Map[String, JsObject]].map(_.keys.toSeq.sorted).getOrElse(Seq.empty)
}

@* Helper to format position for a specific reference *@
@formatPosition(v: VariantV2, refGenome: String) = @{
    v.getCoordinates(refGenome).map { coords =>
        val contig = (coords \ "contig").asOpt[String].getOrElse("?")
        val pos = (coords \ "position").asOpt[Int].getOrElse(0)
        s"$contig:$pos"
    }.getOrElse("-")
}

@* Helper to format alleles for a specific reference *@
@formatAlleles(v: VariantV2, refGenome: String) = @{
    v.getCoordinates(refGenome).map { coords =>
        val ref = (coords \ "ref").asOpt[String].getOrElse("?")
        val alt = (coords \ "alt").asOpt[String].getOrElse("?")
        s"$refâ†’$alt"
    }.getOrElse("-")
}

<div class="mb-3">
    <label for="variantQuery" class="form-label">Search for variant by rsId, common name, or position</label>
    <input type="text"
           class="form-control"
           id="variantQuery"
           name="q"
           value="@query.getOrElse("")"
           placeholder="e.g., rs9786184, M269, chrY:22125503"
           hx-get="@controllers.routes.CuratorController.searchVariantsForHaplogroup(haplogroupId, None)"
           hx-trigger="input changed delay:300ms"
           hx-target="#variant-search-content"
           hx-include="this"
           autocomplete="off">
    <div class="form-text">Enter rsId (rs...) or common name to search.</div>
</div>

@if(query.exists(_.nonEmpty)) {
    @if(variants.isEmpty) {
        <div class="alert alert-info">
            No matching variants found that aren't already associated with @haplogroupName.
        </div>
    } else {
        <div class="list-group">
            @for(variant <- variants.take(10)) {
                @defining(refGenomes(variant)) { refs =>
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>@variant.displayName</strong>
                            @variant.rsIds.headOption.filter(_ != variant.displayName).map { rs =>
                                <span class="text-muted">(@rs)</span>
                            }
                            <span class="badge bg-secondary ms-1">@refs.size build@if(refs.size != 1){s}</span>
                        </div>
                        <button type="button"
                                class="btn btn-success btn-sm"
                                hx-post="@controllers.routes.CuratorController.addVariantToHaplogroup(haplogroupId, variant.variantId.get)"
                                hx-target="#variants-panel"
                                hx-on::after-request="bootstrap.Modal.getInstance(document.getElementById('variantSearchModal')).hide()">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                    <div class="mt-2 ps-2">
                        @for(refGenome <- refs) {
                            <div class="text-muted small">
                                <span class="badge @buildBadgeClass(refGenome) me-1" style="min-width: 55px;">@refGenome</span>
                                <code>@formatPosition(variant, refGenome)</code>
                                <span class="ms-1">@Html(formatAlleles(variant, refGenome))</span>
                            </div>
                        }
                    </div>
                </div>
                }
            }
        </div>
        @if(variants.size > 10) {
            <div class="text-muted small mt-2">
                Showing first 10 of @variants.size results. Refine your search for more specific results.
            </div>
        }
    }
} else {
    <div class="text-muted text-center py-3">
        Start typing to search for variants...
    </div>
}

@buildBadgeClass(refGenome: String) = @{
    refGenome match {
        case "GRCh37" => "bg-warning text-dark"
        case "GRCh38" => "bg-info"
        case "hs1" => "bg-success"
        case _ => "bg-secondary"
    }
}
