@import org.webjars.play.WebJarsUtil
@()(implicit request: RequestHeader, messages: Messages, webJarsUtil: WebJarsUtil)

@main("Genomics Admin") {
    <div class="container py-5">
        <h1 class="mb-4"><i class="bi bi-gear"></i> Genomics Admin</h1>

        @views.html.fragments.flashMessages(request.flash)

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> YBrowse Variant Update</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Download and ingest the latest Y-DNA variant data from YBrowse.
                            This will fetch the GFF file, and update the variant database.
                            <strong>This process takes several hours.</strong> Monitor progress in the server logs.
                        </p>
                        <div id="ybrowse-status" class="mb-3" style="display: none;">
                            <div class="alert mb-0" role="alert">
                                <span id="ybrowse-message"></span>
                            </div>
                        </div>
                        <button id="ybrowse-update-btn" type="button" class="btn btn-primary" onclick="triggerYBrowseUpdate()">
                            <i class="bi bi-cloud-download"></i> Start YBrowse Update
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-box-seam"></i> HipSTR Reference Update</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Download and ingest the latest HipSTR (GRCh38) STR reference data.
                            This will include liftover to hs1 and GRCh37.
                            <strong>This process takes a few minutes.</strong> Monitor progress in the server logs.
                        </p>
                        <div id="hipstr-status" class="mb-3" style="display: none;">
                            <div class="alert mb-0" role="alert">
                                <span id="hipstr-message"></span>
                            </div>
                        </div>
                        <button id="hipstr-update-btn" type="button" class="btn btn-primary" onclick="triggerHipStrUpdate()">
                            <i class="bi bi-cloud-download"></i> Start HipSTR Update
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-map"></i> Genome Regions Bootstrap</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Bootstrap the genome region database (Cytobands, Centromeres, Telomeres, etc.) from hs1 (T2T-CHM13) source files.
                            Includes liftover to GRCh38 and GRCh37.
                            <strong>This is a one-time setup operation.</strong>
                        </p>
                        <div id="regions-status" class="mb-3" style="display: none;">
                            <div class="alert mb-0" role="alert">
                                <span id="regions-message"></span>
                            </div>
                        </div>
                        <button id="regions-update-btn" type="button" class="btn btn-primary" onclick="triggerRegionBootstrap()">
                            <i class="bi bi-play-circle"></i> Start Regions Bootstrap
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function triggerYBrowseUpdate() {
            const btn = document.getElementById('ybrowse-update-btn');
            const status = document.getElementById('ybrowse-status');
            const message = document.getElementById('ybrowse-message');
            const alertDiv = status.querySelector('.alert');

            // Disable button
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Starting...';

            // Fire-and-forget: send request, show immediate feedback
            fetch('@routes.GenomicsAdminController.triggerYBrowseUpdate()', {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                status.style.display = 'block';
                if (data.message && data.message.includes('already in progress')) {
                    alertDiv.className = 'alert alert-warning mb-0';
                    message.textContent = data.message;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-download"></i> Start YBrowse Update';
                } else {
                    alertDiv.className = 'alert alert-success mb-0';
                    message.innerHTML = 'Update started successfully. <strong>Monitor server logs for progress.</strong> This will take several hours.';
                    // Keep button disabled while job is running
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Update Running...';
                }
            })
            .catch(error => {
                status.style.display = 'block';
                alertDiv.className = 'alert alert-danger mb-0';
                message.textContent = 'Failed to start update: ' + error.message;
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cloud-download"></i> Start YBrowse Update';
            });
        }

        function triggerHipStrUpdate() {
            const btn = document.getElementById('hipstr-update-btn');
            const status = document.getElementById('hipstr-status');
            const message = document.getElementById('hipstr-message');
            const alertDiv = status.querySelector('.alert');

            // Disable button
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Starting...';

            // Fire-and-forget: send request, show immediate feedback
            fetch('@routes.GenomicsAdminController.triggerHipStrUpdate()', {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                status.style.display = 'block';
                if (data.message && data.message.includes('already in progress')) { // Assuming similar message for HipSTR
                    alertDiv.className = 'alert alert-warning mb-0';
                    message.textContent = data.message;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cloud-download"></i> Start HipSTR Update';
                } else {
                    alertDiv.className = 'alert alert-success mb-0';
                    message.innerHTML = 'HipSTR update started successfully. <strong>Monitor server logs for progress.</strong> This will take a few minutes.';
                    // Keep button disabled while job is running
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Update Running...';
                }
            })
            .catch(error => {
                status.style.display = 'block';
                alertDiv.className = 'alert alert-danger mb-0';
                message.textContent = 'Failed to start update: ' + error.message;
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cloud-download"></i> Start HipSTR Update';
            });
        }

        function triggerRegionBootstrap() {
            const btn = document.getElementById('regions-update-btn');
            const status = document.getElementById('regions-status');
            const message = document.getElementById('regions-message');
            const alertDiv = status.querySelector('.alert');

            // Disable button
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Starting...';

            // Fire-and-forget: send request, show immediate feedback
            fetch('@routes.GenomicsAdminController.triggerRegionsBootstrap()', {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                status.style.display = 'block';
                alertDiv.className = 'alert alert-success mb-0';
                message.innerHTML = 'Regions bootstrap started successfully. <strong>Monitor server logs for progress.</strong>';
                // Keep button disabled while job is running
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Bootstrap Running...';
            })
            .catch(error => {
                status.style.display = 'block';
                alertDiv.className = 'alert alert-danger mb-0';
                message.textContent = 'Failed to start bootstrap: ' + error.message;
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-circle"></i> Start Regions Bootstrap';
            });
        }
    </script>
}
