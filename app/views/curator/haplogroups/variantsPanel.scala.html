@import models.domain.genomics.VariantV2
@import play.api.libs.json.JsObject
@(haplogroupId: Int, variants: Seq[VariantV2])(implicit request: RequestHeader)

@* Helper to extract reference genomes from coordinates *@
@refGenomes(v: VariantV2) = @{
    v.coordinates.asOpt[Map[String, JsObject]].map(_.keys.toSeq.sorted).getOrElse(Seq.empty)
}

@* Helper to format position for a specific reference *@
@formatPosition(v: VariantV2, refGenome: String) = @{
    v.getCoordinates(refGenome).map { coords =>
        val contig = (coords \ "contig").asOpt[String].getOrElse("?")
        val pos = (coords \ "position").asOpt[Int].getOrElse(0)
        s"$contig:$pos"
    }.getOrElse("-")
}

@* Helper to format alleles for a specific reference *@
@formatAlleles(v: VariantV2, refGenome: String) = @{
    v.getCoordinates(refGenome).map { coords =>
        val ref = (coords \ "ref").asOpt[String].getOrElse("?")
        val alt = (coords \ "alt").asOpt[String].getOrElse("?")
        s"$refâ†’$alt"
    }.getOrElse("-")
}

<div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">
        <i class="bi bi-code-square"></i> Defining Variants
        <span class="badge bg-secondary ms-1">@variants.size</span>
    </h6>
    <button type="button"
            class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#variantSearchModal"
            hx-get="@controllers.routes.CuratorController.searchVariantsForHaplogroup(haplogroupId, None)"
            hx-target="#variant-search-content"
            hx-trigger="click">
        <i class="bi bi-plus"></i> Add
    </button>
</div>

@if(variants.isEmpty) {
    <p class="text-muted small">No variants associated with this haplogroup.</p>
} else {
    @defining(s"variants-$haplogroupId") { containerId =>
    <div class="mb-2">
        <input type="text"
               class="form-control form-control-sm variant-filter-input"
               data-container="@containerId"
               placeholder="Filter variants...">
    </div>

    <div id="@containerId" class="variants-container" style="max-height: 300px; overflow-y: auto;" data-total="@variants.size">
        <ul class="list-group list-group-flush small">
            @for(variant <- variants) {
                @defining(refGenomes(variant)) { refs =>
                <li class="list-group-item px-0 variant-item" data-variant-name="@variant.displayName.toLowerCase @variant.rsIds.mkString(" ").toLowerCase @variant.canonicalName.getOrElse("").toLowerCase">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>@variant.displayName</strong>
                            @variant.rsIds.headOption.filter(_ != variant.canonicalName.getOrElse("")).map { rs =>
                                <span class="text-muted ms-1">(@rs)</span>
                            }
                            <span class="badge bg-secondary ms-1">@refs.size build@if(refs.size != 1){s}</span>
                        </div>
                        @variant.variantId.map { vid =>
                        <button type="button"
                                class="btn btn-outline-danger btn-sm py-0 px-1"
                                hx-delete="@controllers.routes.CuratorController.removeVariantFromHaplogroup(haplogroupId, vid)"
                                hx-target="#variants-panel"
                                hx-confirm="Remove @variant.displayName from this haplogroup?">
                            <i class="bi bi-x"></i>
                        </button>
                        }
                    </div>
                    <div class="mt-1 ps-2">
                        @for(refGenome <- refs) {
                            <div class="text-muted small">
                                <span class="badge bg-info me-1" style="min-width: 55px;">@refGenome</span>
                                <code>@formatPosition(variant, refGenome)</code>
                                <span class="ms-1">@Html(formatAlleles(variant, refGenome))</span>
                            </div>
                        }
                    </div>
                </li>
                }
            }
        </ul>
    </div>

    <div class="variant-filter-status text-muted small mt-1" data-container="@containerId" style="display: none;">
        Showing <span class="visible-count">0</span> of @variants.size variants
    </div>
    }

    <script>
        (function() {
            document.querySelectorAll('.variant-filter-input').forEach(input => {
                input.addEventListener('keyup', function() {
                    const containerId = this.getAttribute('data-container');
                    const container = document.getElementById(containerId);
                    const statusDiv = document.querySelector('.variant-filter-status[data-container="' + containerId + '"]');
                    const items = container.querySelectorAll('.variant-item');
                    const query = this.value.toLowerCase().trim();
                    let visible = 0;

                    items.forEach(item => {
                        const name = item.getAttribute('data-variant-name');
                        if (query === '' || name.includes(query)) {
                            item.style.display = '';
                            visible++;
                        } else {
                            item.style.display = 'none';
                        }
                    });

                    if (query === '') {
                        statusDiv.style.display = 'none';
                    } else {
                        statusDiv.style.display = '';
                        statusDiv.querySelector('.visible-count').textContent = visible;
                    }
                });
            });
        })();
    </script>
}

<!-- Modal for variant search -->
<div class="modal fade" id="variantSearchModal" tabindex="-1" aria-labelledby="variantSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="variantSearchModalLabel">Add Variant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="variant-search-content">
                <!-- Content loaded via HTMX -->
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
