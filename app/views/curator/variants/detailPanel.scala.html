@import models.domain.genomics.{VariantWithContig, VariantGroup}
@import models.dal.domain.genomics.VariantAlias
@import models.domain.haplogroups.Haplogroup
@import models.domain.curator.AuditLogEntry
@(vwc: VariantWithContig, variantGroup: Option[VariantGroup], aliases: Seq[VariantAlias], haplogroups: Seq[Haplogroup], history: Seq[AuditLogEntry])(implicit request: RequestHeader)

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">@vwc.variant.rsId.orElse(vwc.variant.commonName).getOrElse(s"Variant ${vwc.variant.variantId.get}")</h5>
        <span class="badge bg-secondary">@vwc.variant.variantType</span>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-4">rsId</dt>
            <dd class="col-sm-8">@vwc.variant.rsId.getOrElse("-")</dd>

            <dt class="col-sm-4">Common Name</dt>
            <dd class="col-sm-8">@vwc.variant.commonName.getOrElse("-")</dd>

            <dt class="col-sm-4">Ancestral</dt>
            <dd class="col-sm-8"><code>@vwc.variant.referenceAllele</code></dd>

            <dt class="col-sm-4">Derived</dt>
            <dd class="col-sm-8"><code>@vwc.variant.alternateAllele</code></dd>

            <dt class="col-sm-4">Type</dt>
            <dd class="col-sm-8">@vwc.variant.variantType</dd>
        </dl>

        @if(aliases.nonEmpty) {
            <hr>
            <h6><i class="bi bi-tags"></i> Alternative Names</h6>
            @defining(aliases.groupBy(_.aliasType)) { aliasesByType =>
                <div class="mb-3">
                    @for((aliasType, typeAliases) <- aliasesByType) {
                        <div class="mb-2">
                            <small class="text-muted">@formatAliasType(aliasType):</small>
                            @for(alias <- typeAliases) {
                                <span class="badge @if(alias.isPrimary){bg-primary}else{bg-outline-secondary border} me-1"
                                      title="Source: @alias.source.getOrElse("unknown")">
                                    @alias.aliasValue
                                    @if(alias.isPrimary){<i class="bi bi-star-fill ms-1" style="font-size: 0.6rem;"></i>}
                                </span>
                            }
                        </div>
                    }
                </div>
            }
        }

        <hr>

        <h6><i class="bi bi-collection"></i> Reference Builds</h6>
        @variantGroup match {
            case Some(group) if group.variants.size > 1 => {
                @defining(group.variantsSorted.head) { first =>
                    @if(group.variantsSorted.tail.exists(v => v.variant.referenceAllele != first.variant.referenceAllele || v.variant.alternateAllele != first.variant.alternateAllele)) {
                        <div class="alert alert-warning py-1 px-2 small mb-2">
                            <i class="bi bi-arrow-left-right"></i> Strand difference (reverse complement)
                        </div>
                    }
                }
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Build</th>
                                <th>Position</th>
                                <th>Alleles</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(v <- group.variantsSorted) {
                                <tr class="@if(v.variant.variantId == vwc.variant.variantId){table-active}">
                                    <td>
                                        <span class="badge @buildBadgeClass(v.shortReferenceGenome)">
                                            @v.shortReferenceGenome
                                        </span>
                                    </td>
                                    <td><code>@v.formattedPosition</code></td>
                                    <td>
                                        <code>@v.variant.referenceAllele</code>
                                        <i class="bi bi-arrow-right text-muted" style="font-size: 0.7rem;"></i>
                                        <code>@v.variant.alternateAllele</code>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            case _ => {
                <div class="mb-3">
                    <span class="badge @buildBadgeClass(vwc.shortReferenceGenome)">@vwc.shortReferenceGenome</span>
                    <code class="ms-2">@vwc.formattedPosition</code>
                    <span class="ms-2">
                        <code>@vwc.variant.referenceAllele</code>
                        <i class="bi bi-arrow-right text-muted" style="font-size: 0.7rem;"></i>
                        <code>@vwc.variant.alternateAllele</code>
                    </span>
                </div>
            }
        }

        <hr>

        <h6><i class="bi bi-diagram-3"></i> Used By Haplogroups</h6>
        @if(haplogroups.isEmpty) {
            <p class="text-muted small">This variant is not associated with any haplogroups.</p>
        } else {
            <div class="mb-3">
                @for(hg <- haplogroups.take(10)) {
                    <a href="#"
                       class="badge @if(hg.haplogroupType.toString == "Y"){bg-primary}else{bg-success} text-decoration-none me-1"
                       hx-get="@controllers.routes.CuratorController.haplogroupDetailPanel(hg.id.get)"
                       hx-target="#detail-panel">
                        @hg.name
                    </a>
                }
                @if(haplogroups.size > 10) {
                    <span class="text-muted small">+@(haplogroups.size - 10) more</span>
                }
            </div>
        }

        <hr>

        <div class="d-flex gap-2">
            @variantGroup match {
                case Some(group) if group.variants.size > 1 => {
                    <a href="@controllers.routes.CuratorController.editVariantGroupForm(group.groupKey)"
                       class="btn btn-primary btn-sm">
                        <i class="bi bi-pencil"></i> Edit Group (@group.variants.size builds)
                    </a>
                }
                case _ => {
                    <a href="@controllers.routes.CuratorController.editVariantForm(vwc.variant.variantId.get)"
                       class="btn btn-primary btn-sm">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                }
            }
            <button type="button"
                    class="btn btn-danger btn-sm"
                    hx-delete="@controllers.routes.CuratorController.deleteVariant(vwc.variant.variantId.get)"
                    hx-confirm="Are you sure you want to delete this variant? @variantGroup.filter(_.variants.size > 1).map(g => s"This will only delete the ${vwc.shortReferenceGenome} build.").getOrElse("")">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>

        @if(history.nonEmpty) {
            <hr>
            <h6><i class="bi bi-clock-history"></i> Recent History</h6>
            <ul class="list-group list-group-flush small">
                @for(entry <- history.take(5)) {
                    <li class="list-group-item px-0">
                        <span class="badge @actionBadgeClass(entry.action) me-1">@entry.action</span>
                        @entry.createdAt.toLocalDate
                        @entry.comment.map { c => <br><small class="text-muted">@c</small> }
                    </li>
                }
            </ul>
            @if(history.size > 5) {
                <a href="#"
                   class="small"
                   hx-get="@controllers.routes.CuratorController.auditHistory("variant", vwc.variant.variantId.get)"
                   hx-target="#detail-panel">
                    View all history...
                </a>
            }
        }
    </div>
</div>

@formatAliasType(aliasType: String) = @{
    aliasType match {
        case "common_name" => "SNP Names"
        case "rs_id" => "dbSNP IDs"
        case "isogg" => "ISOGG"
        case "yfull" => "YFull"
        case "ftdna" => "FTDNA"
        case other => other.replace("_", " ").capitalize
    }
}

@buildBadgeClass(refGenome: String) = @{
    refGenome match {
        case "GRCh37" => "bg-warning text-dark"
        case "GRCh38" => "bg-info"
        case "hs1" => "bg-success"
        case _ => "bg-secondary"
    }
}

@actionBadgeClass(action: String) = @{
    action match {
        case "create" => "bg-success"
        case "update" => "bg-warning text-dark"
        case "delete" => "bg-danger"
        case _ => "bg-secondary"
    }
}
