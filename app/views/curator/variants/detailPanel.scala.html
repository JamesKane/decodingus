@import models.domain.genomics.{NamingStatus, VariantV2}
@import models.domain.haplogroups.Haplogroup
@import models.domain.curator.AuditLogEntry
@import play.api.libs.json.JsObject
@(variant: VariantV2, haplogroups: Seq[Haplogroup], history: Seq[AuditLogEntry])(implicit request: RequestHeader)

@* Helper to extract reference genomes from coordinates *@
@refGenomes = @{
    variant.coordinates.asOpt[Map[String, JsObject]].map(_.keys.toSeq.sorted).getOrElse(Seq.empty)
}

@* Helper to format position for a specific reference *@
@formatPosition(refGenome: String) = @{
    variant.getCoordinates(refGenome).map { coords =>
        val contig = (coords \ "contig").asOpt[String].getOrElse("?")
        val pos = (coords \ "position").asOpt[Int].getOrElse(0)
        s"$contig:$pos"
    }.getOrElse("-")
}

@* Helper to format alleles for a specific reference *@
@formatAlleles(refGenome: String) = @{
    variant.getCoordinates(refGenome).map { coords =>
        val ref = (coords \ "ref").asOpt[String].getOrElse("?")
        val alt = (coords \ "alt").asOpt[String].getOrElse("?")
        s"$refâ†’$alt"
    }.getOrElse("-")
}

@* Helper to get primary alleles (prefer hs1, then GRCh38) *@
@primaryAlleles = @{
    val coords = variant.coordinates.asOpt[Map[String, JsObject]].getOrElse(Map.empty)
    val primary = coords.get("hs1").orElse(coords.get("GRCh38")).orElse(coords.headOption.map(_._2))
    primary.map { c =>
        val ref = (c \ "ref").asOpt[String].getOrElse("?")
        val alt = (c \ "alt").asOpt[String].getOrElse("?")
        (ref, alt)
    }.getOrElse(("?", "?"))
}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">@variant.displayName</h5>
        <span class="badge bg-secondary">@variant.mutationType</span>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-4">Canonical Name</dt>
            <dd class="col-sm-8">@variant.canonicalName.getOrElse("-")</dd>

            <dt class="col-sm-4">rsIds</dt>
            <dd class="col-sm-8">
                @if(variant.rsIds.nonEmpty) {
                    @for(rsId <- variant.rsIds) {
                        <span class="badge bg-light text-dark border me-1">@rsId</span>
                    }
                } else { - }
            </dd>

            @defining(primaryAlleles) { alleles =>
                <dt class="col-sm-4">Ancestral</dt>
                <dd class="col-sm-8"><code>@alleles._1</code></dd>

                <dt class="col-sm-4">Derived</dt>
                <dd class="col-sm-8"><code>@alleles._2</code></dd>
            }

            <dt class="col-sm-4">Type</dt>
            <dd class="col-sm-8">@variant.mutationType.displayName</dd>

            <dt class="col-sm-4">Naming Status</dt>
            <dd class="col-sm-8">
                <span class="badge @if(variant.namingStatus == NamingStatus.Named){bg-success}else if(variant.namingStatus == NamingStatus.PendingReview){bg-warning text-dark}else{bg-secondary}">
                    @variant.namingStatus.displayName
                </span>
            </dd>
        </dl>

        @if(variant.commonNames.nonEmpty) {
            <hr>
            <h6><i class="bi bi-tags"></i> Alternative Names</h6>
            <div class="mb-2">
                @for(name <- variant.commonNames) {
                    <span class="badge bg-light text-dark border me-1">@name</span>
                }
            </div>
        }

        <hr>

        <h6><i class="bi bi-collection"></i> Reference Builds</h6>
        @if(refGenomes.isEmpty) {
            <p class="text-muted small">No coordinates available.</p>
        } else {
            <div class="table-responsive">
                <table class="table table-sm small">
                    <thead>
                        <tr>
                            <th>Build</th>
                            <th>Position</th>
                            <th>Alleles</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(ref <- refGenomes) {
                            <tr>
                                <td>
                                    <span class="badge @buildBadgeClass(ref)">@ref</span>
                                </td>
                                <td><code>@formatPosition(ref)</code></td>
                                <td>@Html(formatAlleles(ref))</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <hr>

        <h6><i class="bi bi-diagram-3"></i> Used By Haplogroups</h6>
        @if(haplogroups.isEmpty) {
            <p class="text-muted small">This variant is not associated with any haplogroups.</p>
        } else {
            <div class="mb-3">
                @for(hg <- haplogroups.take(10)) {
                    <a href="#"
                       class="badge @if(hg.haplogroupType.toString == "Y"){bg-primary}else{bg-success} text-decoration-none me-1"
                       hx-get="@controllers.routes.CuratorController.haplogroupDetailPanel(hg.id.get)"
                       hx-target="#detail-panel">
                        @hg.name
                    </a>
                }
                @if(haplogroups.size > 10) {
                    <span class="text-muted small">+@(haplogroups.size - 10) more</span>
                }
            </div>
        }

        @variant.notes.map { notes =>
            <hr>
            <h6><i class="bi bi-sticky"></i> Notes</h6>
            <p class="small">@notes</p>
        }

        <hr>

        <div class="d-flex gap-2">
            <a href="@controllers.routes.CuratorController.editVariantForm(variant.variantId.get)"
               class="btn btn-primary btn-sm">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <button type="button"
                    class="btn btn-danger btn-sm"
                    hx-delete="@controllers.routes.CuratorController.deleteVariant(variant.variantId.get)"
                    hx-confirm="Are you sure you want to delete this variant?">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>

        @if(history.nonEmpty) {
            <hr>
            <h6><i class="bi bi-clock-history"></i> Recent History</h6>
            <ul class="list-group list-group-flush small">
                @for(entry <- history.take(5)) {
                    <li class="list-group-item px-0">
                        <span class="badge @actionBadgeClass(entry.action) me-1">@entry.action</span>
                        @entry.createdAt.toLocalDate
                        @entry.comment.map { c => <br><small class="text-muted">@c</small> }
                    </li>
                }
            </ul>
            @if(history.size > 5) {
                <a href="#"
                   class="small"
                   hx-get="@controllers.routes.CuratorController.auditHistory("variant", variant.variantId.get)"
                   hx-target="#detail-panel">
                    View all history...
                </a>
            }
        }
    </div>
</div>

@buildBadgeClass(refGenome: String) = @{
    refGenome match {
        case "GRCh37" => "bg-warning text-dark"
        case "GRCh38" => "bg-info"
        case "hs1" => "bg-success"
        case _ => "bg-secondary"
    }
}

@actionBadgeClass(action: String) = @{
    action match {
        case "create" => "bg-success"
        case "update" => "bg-warning text-dark"
        case "delete" => "bg-danger"
        case _ => "bg-secondary"
    }
}
