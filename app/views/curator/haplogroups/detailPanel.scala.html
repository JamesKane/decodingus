@import models.domain.haplogroups.Haplogroup
@import models.domain.genomics.VariantV2
@import models.domain.curator.AuditLogEntry
@import utils.CuratorViewUtils
@(haplogroup: Haplogroup, parentOpt: Option[Haplogroup], children: Seq[Haplogroup], variants: Seq[VariantV2], history: Seq[AuditLogEntry])(implicit request: RequestHeader)

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">@haplogroup.name</h5>
        <span class="badge @if(haplogroup.haplogroupType.toString == "Y"){bg-primary}else{bg-success}">
            @haplogroup.haplogroupType
        </span>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-4">Lineage</dt>
            <dd class="col-sm-8">@haplogroup.lineage.getOrElse("-")</dd>

            <dt class="col-sm-4">Description</dt>
            <dd class="col-sm-8">@haplogroup.description.getOrElse("-")</dd>

            <dt class="col-sm-4">Source</dt>
            <dd class="col-sm-8">@haplogroup.source</dd>

            <dt class="col-sm-4">Confidence</dt>
            <dd class="col-sm-8">@haplogroup.confidenceLevel</dd>

            @if(haplogroup.formedYbp.isDefined || haplogroup.tmrcaYbp.isDefined) {
                <dt class="col-sm-4">Branch Ages</dt>
                <dd class="col-sm-8">
                    @haplogroup.formedEstimate.map { est =>
                        <div><small class="text-muted">Formed:</small> @est.formattedWithRange</div>
                    }
                    @haplogroup.tmrcaEstimate.map { est =>
                        <div><small class="text-muted">TMRCA:</small> @est.formattedWithRange</div>
                    }
                    @haplogroup.ageEstimateSource.map { src =>
                        <div class="mt-1"><small class="text-muted">Source: @src</small></div>
                    }
                </dd>
            }

            <dt class="col-sm-4">Valid From</dt>
            <dd class="col-sm-8">@haplogroup.validFrom.toLocalDate</dd>

            @haplogroup.validUntil.map { until =>
                <dt class="col-sm-4">Valid Until</dt>
                <dd class="col-sm-8">@until.toLocalDate</dd>
            }
        </dl>

        @haplogroup.provenance.map { prov =>
            <hr>
            <h6><i class="bi bi-people"></i> Provenance</h6>
            <dl class="row mb-0">
                <dt class="col-sm-4">Primary Credit</dt>
                <dd class="col-sm-8">
                    <span class="badge @if(prov.primaryCredit.equalsIgnoreCase("ISOGG")){bg-warning text-dark}else if(prov.primaryCredit.equalsIgnoreCase("DecodingUs")){bg-primary}else{bg-secondary}">
                        @prov.primaryCredit
                    </span>
                </dd>

                @if(prov.nodeProvenance.nonEmpty) {
                    <dt class="col-sm-4">Contributors</dt>
                    <dd class="col-sm-8">
                        @for(source <- prov.nodeProvenance.toSeq.sorted) {
                            <span class="badge bg-light text-dark border me-1">@source</span>
                        }
                    </dd>
                }

                @prov.lastMergedFrom.map { source =>
                    <dt class="col-sm-4">Last Merged</dt>
                    <dd class="col-sm-8">
                        <small>
                            from <strong>@source</strong>
                            @prov.lastMergedAt.map { ts =>
                                on @ts.toLocalDate
                            }
                        </small>
                    </dd>
                }

                @if(prov.variantProvenance.nonEmpty) {
                    <dt class="col-sm-4">Variant Sources</dt>
                    <dd class="col-sm-8">
                        <button class="btn btn-sm btn-outline-secondary"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#variant-provenance-@haplogroup.id.get"
                                aria-expanded="false">
                            <i class="bi bi-chevron-down"></i> @prov.variantProvenance.size variants
                        </button>
                        <div class="collapse mt-2" id="variant-provenance-@haplogroup.id.get">
                            <ul class="list-group list-group-flush small">
                                @for((variant, sources) <- prov.variantProvenance.toSeq.sortBy(_._1).take(20)) {
                                    <li class="list-group-item px-0 py-1 d-flex justify-content-between">
                                        <code>@variant</code>
                                        <span>
                                            @for(src <- sources.toSeq.sorted) {
                                                <span class="badge bg-light text-dark border">@src</span>
                                            }
                                        </span>
                                    </li>
                                }
                                @if(prov.variantProvenance.size > 20) {
                                    <li class="list-group-item px-0 py-1 text-muted">
                                        +@(prov.variantProvenance.size - 20) more variants...
                                    </li>
                                }
                            </ul>
                        </div>
                    </dd>
                }
            </dl>
        }

        <hr>

        <h6><i class="bi bi-diagram-3"></i> Tree Position</h6>
        <dl class="row mb-0">
            <dt class="col-sm-4">Parent</dt>
            <dd class="col-sm-8">
                @parentOpt.map { parent =>
                    <a href="#"
                       hx-get="@controllers.routes.CuratorController.haplogroupDetailPanel(parent.id.get)"
                       hx-target="#detail-panel">
                        @parent.name
                    </a>
                }.getOrElse { <span class="text-muted">Root</span> }
            </dd>

            <dt class="col-sm-4">Children</dt>
            <dd class="col-sm-8">
                @if(children.isEmpty) {
                    <span class="text-muted">None</span>
                } else {
                    @for(child <- children.take(10)) {
                        <a href="#"
                           class="badge bg-secondary text-decoration-none me-1"
                           hx-get="@controllers.routes.CuratorController.haplogroupDetailPanel(child.id.get)"
                           hx-target="#detail-panel">
                            @child.name
                        </a>
                    }
                    @if(children.size > 10) {
                        <span class="text-muted">+@(children.size - 10) more</span>
                    }
                }
            </dd>
        </dl>

        <hr>

        <div id="variants-panel">
            @variantsPanel(haplogroup.id.get, variants)
        </div>

        <hr>

        <div class="d-flex gap-2 flex-wrap">
            <a href="@controllers.routes.CuratorController.editHaplogroupForm(haplogroup.id.get)"
               class="btn btn-primary btn-sm">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href="@controllers.routes.CuratorController.splitBranchForm(haplogroup.id.get)"
               class="btn btn-outline-primary btn-sm">
                <i class="bi bi-diagram-3"></i> Split
            </a>
            @parentOpt.map { _ =>
                <a href="@controllers.routes.CuratorController.mergeConfirmForm(haplogroup.id.get)"
                   class="btn btn-outline-warning btn-sm">
                    <i class="bi bi-arrow-up-circle"></i> Merge into Parent
                </a>
            }
            <a href="@controllers.routes.CuratorController.reparentForm(haplogroup.id.get)"
               class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-up-right-circle"></i> Reparent
            </a>
            <button type="button"
                    class="btn btn-danger btn-sm"
                    hx-delete="@controllers.routes.CuratorController.deleteHaplogroup(haplogroup.id.get)"
                    hx-confirm="Are you sure you want to delete '@haplogroup.name'? Children will be moved to the parent haplogroup.">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>

        @if(history.nonEmpty) {
            <hr>
            <h6><i class="bi bi-clock-history"></i> Recent History</h6>
            <ul class="list-group list-group-flush small">
                @for(entry <- history.take(5)) {
                    <li class="list-group-item px-0">
                        <span class="badge @CuratorViewUtils.actionBadgeClass(entry.action) me-1">@entry.action</span>
                        @entry.createdAt.toLocalDate
                        @entry.comment.map { c => <br><small class="text-muted">@c</small> }
                    </li>
                }
            </ul>
            @if(history.size > 5) {
                <a href="@controllers.routes.CuratorController.auditHistory("haplogroup", haplogroup.id.get)"
                   class="small"
                   hx-get="@controllers.routes.CuratorController.auditHistory("haplogroup", haplogroup.id.get)"
                   hx-target="#detail-panel">
                    View all history...
                </a>
            }
        }
    </div>
</div>