@import org.webjars.play.WebJarsUtil
@import controllers.ReparentFormData
@import models.domain.haplogroups.Haplogroup
@(haplogroup: Haplogroup, currentParent: Option[Haplogroup], potentialParents: Seq[Haplogroup], form: Form[ReparentFormData])(implicit request: RequestHeader, messages: Messages, webJarsUtil: WebJarsUtil)

@main(s"Reparent ${haplogroup.name}") {
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="@controllers.routes.CuratorController.dashboard">Curator</a></li>
                        <li class="breadcrumb-item"><a href="@controllers.routes.CuratorController.listHaplogroups(None, None, 1, 20)">Haplogroups</a></li>
                        <li class="breadcrumb-item">@haplogroup.name</li>
                        <li class="breadcrumb-item active">Reparent</li>
                    </ol>
                </nav>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-arrow-up-right-circle"></i> Reparent @haplogroup.name</h5>
                    </div>
                    <div class="card-body">
                        @form.globalError.map { error =>
                            <div class="alert alert-danger">@error.message</div>
                        }

                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle"></i>
                            <strong>Current Structure:</strong>
                            @currentParent match {
                                case Some(parent) => {
                                    <span class="badge bg-primary">@parent.name</span> &rarr; <span class="badge bg-secondary">@haplogroup.name</span>
                                }
                                case None => {
                                    <span class="badge bg-secondary">@haplogroup.name</span> <em>(root node - no parent)</em>
                                }
                            }
                        </div>

                        @helper.form(controllers.routes.CuratorController.reparent(haplogroup.id.get)) {
                            @helper.CSRF.formField

                            <div class="mb-3">
                                <label for="newParentId" class="form-label">New Parent *</label>
                                <select class="form-select @if(form.error("newParentId").isDefined){is-invalid}"
                                        id="newParentId"
                                        name="newParentId"
                                        required>
                                    <option value="">Select new parent...</option>
                                    @for(parent <- potentialParents.sortBy(_.name)) {
                                        <option value="@parent.id.get"
                                                @if(form("newParentId").value.contains(parent.id.get.toString)){selected}
                                                @if(currentParent.flatMap(_.id) == parent.id){disabled}>
                                            @parent.name
                                            @if(currentParent.flatMap(_.id) == parent.id){ (current parent)}
                                        </option>
                                    }
                                </select>
                                @form.error("newParentId").map { error =>
                                    <div class="invalid-feedback">@error.message</div>
                                }
                                <div class="form-text">
                                    Select the haplogroup that @haplogroup.name should become a child of.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="source" class="form-label">Source Attribution *</label>
                                <input type="text"
                                       class="form-control @if(form.error("source").isDefined){is-invalid}"
                                       id="source"
                                       name="source"
                                       value="@form("source").value.getOrElse("")"
                                       placeholder="e.g., post-merge-cleanup, ISOGG 2024, curator-correction"
                                       required>
                                @form.error("source").map { error =>
                                    <div class="invalid-feedback">@error.message</div>
                                }
                                <div class="form-text">
                                    Attribution for this structural change (e.g., "post-merge-cleanup", "curator-correction").
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="reason" class="form-label">Reason for Change</label>
                                <textarea class="form-control"
                                          id="reason"
                                          name="reason"
                                          rows="3"
                                          placeholder="Optional: Explain why this reparent is needed...">@form("reason").value.getOrElse("")</textarea>
                                <div class="form-text">
                                    Optional explanation for the audit log.
                                </div>
                            </div>

                            <div class="alert alert-warning mb-4">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Warning:</strong> Reparenting will move <strong>@haplogroup.name</strong> and all its descendants
                                to the new location in the tree. This operation is logged and can be reviewed in the audit history.
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-arrow-up-right-circle"></i> Reparent
                                </button>
                                <a href="@controllers.routes.CuratorController.haplogroupDetailPanel(haplogroup.id.get)"
                                   class="btn btn-outline-secondary"
                                   hx-get="@controllers.routes.CuratorController.haplogroupDetailPanel(haplogroup.id.get)"
                                   hx-target="#detail-panel">
                                    Cancel
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}
