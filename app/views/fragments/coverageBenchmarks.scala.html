@import models.domain.genomics.{CoverageBenchmark, SequencingLab}

@(benchmarks: Seq[CoverageBenchmark], lab: Option[SequencingLab])

@* Helper function to calculate 95% confidence interval *@
@calculateCI(mean: Option[Double], stddev: Option[Double], n: Int) = @{
    (mean, stddev) match {
        case (Some(m), Some(sd)) if n > 1 =>
            val margin = 1.96 * sd / math.sqrt(n)
            val lower = m - margin
            val upper = m + margin
            f"$m%.1f ($lower%.1f-$upper%.1f)"
        case (Some(m), _) =>
            f"$m%.1f"
        case _ =>
            "-"
    }
}

@lab.map { l =>
    <div class="card mb-4">
        <div class="card-header">
            <h3>@l.name</h3>
        </div>
        <div class="card-body">
            @l.descriptionMarkdown.map { desc =>
                <div class="mb-3">
                    @Html(desc)
                </div>
            }
            @l.websiteUrl.map { url =>
                <p>
                    <strong>Website:</strong> <a href="@url" target="_blank" rel="noopener noreferrer">@url <i class="bi bi-box-arrow-up-right"></i></a>
                </p>
            }
        </div>
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Test Type</th>
                <th>Contig</th>
                <th>Mean Read Length</th>
                <th>Read Length Range</th>
                <th>Mean Insert Size</th>
                <th>Insert Size Range</th>
                <th>Mean Depth</th>
                <th>Bases No Coverage</th>
                <th>Low Quality Mapping</th>
                <th>Callable Bases</th>
                <th>Mean Mapping Quality</th>
                <th>Samples</th>
            </tr>
        </thead>
        <tbody>
        @for(benchmark <- benchmarks) {
            <tr>
                <td>@benchmark.testType</td>
                <td>@benchmark.contig</td>
                <td>@benchmark.meanReadLen.map(v => f"$v%.1f").getOrElse("-")</td>
                <td>
                    @benchmark.minReadLen.map(_.toString).getOrElse("-") -
                    @benchmark.maxReadLen.map(_.toString).getOrElse("-")
                </td>
                <td>@benchmark.meanInsertLen.map(v => f"$v%.1f").getOrElse("-")</td>
                <td>
                    @benchmark.minInsertLen.map(_.toString).getOrElse("-") -
                    @benchmark.maxInsertLen.map(_.toString).getOrElse("-")
                </td>
                <td>@calculateCI(benchmark.meanDepthAvg, benchmark.meanDepthStddev, benchmark.numSamples)</td>
                <td>@calculateCI(benchmark.basesNoCoverageAvg, benchmark.basesNoCoverageStddev, benchmark.numSamples)</td>
                <td>@calculateCI(benchmark.basesLowQualMappingAvg, benchmark.basesLowQualMappingStddev, benchmark.numSamples)</td>
                <td>@calculateCI(benchmark.basesCallableAvg, benchmark.basesCallableStddev, benchmark.numSamples)</td>
                <td>@benchmark.meanMappingQuality.map(v => f"$v%.1f").getOrElse("-")</td>
                <td>
                    <span class="badge bg-primary">@benchmark.numSamples</span>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@if(benchmarks.isEmpty) {
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i> No benchmark data available for this laboratory.
    </div>
}