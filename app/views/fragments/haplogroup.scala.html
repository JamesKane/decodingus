@import controllers.routes.TreeController
@import models.HaplogroupType
@import models.HaplogroupType.{MT, Y}
@import models.api.TreeDTO
@import models.view.TreeViewModel

@(tree: TreeDTO, hapType: HaplogroupType, renderedTreeData: Option[TreeViewModel], currentUrl: String, showBranchAgeEstimates: Boolean = false)(implicit messages: Messages)

@fullPageUrl(haplogroup: Option[String]) = @{
    hapType match {
        case Y => TreeController.ytree(haplogroup)
        case MT => TreeController.mtree(haplogroup)
    }
}

@fragmentUrl(haplogroup: Option[String]) = @{
    hapType match {
        case Y => TreeController.yTreeFragment(haplogroup)
        case MT => TreeController.mTreeFragment(haplogroup)
    }
}

<nav aria-label="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
    <ol class="breadcrumb">
        @for((crumb, index) <- tree.crumbs.zipWithIndex) {
            <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a href="@fullPageUrl(Some(crumb.label))" itemprop="item" hx-get="@crumb.url" hx-target="#tree-container" hx-push-url="@fullPageUrl(Some(crumb.label))">
                    <span itemprop="name">@crumb.label</span>
                </a>
                <meta itemprop="position" content="${index + 1}"/>
            </li>
        }
        <li class="breadcrumb-item active" aria-current="page" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="@currentUrl" itemprop="item">
                <span itemprop="name">@tree.name</span>
            </a>
            <meta itemprop="position" content="${tree.crumbs.size + 1}"/>
        </li>
    </ol>
</nav>

<div class="mb-3">
    <small class="text-muted">
        <span class="me-4"><span style="display: inline-block;
            width: 24px;
            height: 24px;
            background-color: #d4edda;
            border: 2px solid #2e7d32;
            border-radius: 3px;
            vertical-align: middle;"></span> <strong>✓</strong> @messages("tree.legend.established")</span>
        <span class="me-4"><span style="display: inline-block;
            width: 24px;
            height: 24px;
            background-color: #ffeeba;
            border: 2px dashed #e65100;
            border-radius: 3px;
            vertical-align: middle;"></span> <strong>★</strong> @messages("tree.legend.updated")</span>
    </small>
</div>

<div id="tree-and-sidebar-container">
    <div id="phylogenetic-tree-root">
    @renderedTreeData.map { rtd =>
    <svg id="phylogenetic-tree-svg" width="@rtd.svgWidth" height="@rtd.svgHeight">

        @for(link <- rtd.allLinks) {
            <path class="link" d="@link.pathData"></path>
        }

        @for(node <- rtd.allNodes) {
            <g class="node">
                <rect class="node-rect @if(node.isBackbone){node-established}else if(node.isRecentlyUpdated){node-recent}"
                x="@(node.y - 75)"
                y="@(node.x - 40)"
                width="150" height="80" rx="4" ry="4"
                hx-get="@fragmentUrl(Option(node.name))"
                hx-target="#tree-container"
                hx-push-url="@fullPageUrl(Option(node.name))"
                style="fill: @node.fillColor; cursor: pointer;">
                    <title>@node.name (@messages("tree.reRoot"))</title>
                </rect>
                @* Header bar *@
                <rect class="node-header"
                x="@(node.y - 75)"
                y="@(node.x - 40)"
                width="150" height="22" rx="4" ry="4"
                style="fill: @if(node.isBackbone){#2e7d32}else if(node.isRecentlyUpdated){#e65100}else{#555}; pointer-events: none;"/>
                <rect x="@(node.y - 75)" y="@(node.x - 22)" width="150" height="4" style="fill: @if(node.isBackbone){#2e7d32}else if(node.isRecentlyUpdated){#e65100}else{#555}; pointer-events: none;"/>
                @* Name row with icon *@
                <text class="node-name"
                x="@(node.y)"
                y="@(node.x - 25)"
                text-anchor="middle">
                @if(node.isBackbone){✓ }@if(node.isRecentlyUpdated){★ }@node.name
                </text>
                @* Variants row *@
                <text class="node-variant-link"
                x="@(node.y + 70)"
                y="@(node.x - 5)"
                text-anchor="end"
                hx-get="@TreeController.getSnpDetailSidebar(node.name, hapType)"
                hx-target="#snpDetailSidebarPlaceholder"
                hx-swap="outerHTML"
                hx-trigger="click">
                    @node.variantsCount.map(c => s"$c variants ▸").getOrElse("—")
                    <title>@messages("tree.clickToSeeVariants", node.variantsCount.getOrElse(0))</title>
                </text>
                @if(showBranchAgeEstimates) {
                    @* Formed row *@
                    <text class="node-detail node-date"
                    x="@(node.y - 70)"
                    y="@(node.x + 12)"
                    text-anchor="start">
                        Formed: @node.formedFormatted.getOrElse("—")
                    </text>
                    @* TMRCA row *@
                    <text class="node-detail node-date"
                    x="@(node.y - 70)"
                    y="@(node.x + 29)"
                    text-anchor="start">
                        TMRCA: @node.tmrcaFormatted.getOrElse("—")
                    </text>
                }
            </g>
        }
    </svg>
    }.getOrElse {
        <div class="alert alert-warning">@messages("tree.noData")</div>
    }
    </div>

    <div id="snpDetailSidebarPlaceholder"></div>

</div>
<style>

        #phylogenetic-tree-root {
            width: 100%;
            max-height: calc(100vh - 200px);
            overflow: auto;
            border: 1px solid #ddd;
            background-color: #f0f0f0;

            /* Add styles for scroll indicators */
            background-image: linear-gradient(to right, #f0f0f0, #f0f0f0),
            linear-gradient(to right, #f0f0f0, #f0f0f0),
            linear-gradient(to right, rgba(0, 0, 0, 0.25), rgba(255, 255, 255, 0)),
            linear-gradient(to left, rgba(0, 0, 0, 0.25), rgba(255, 255, 255, 0));
            background-position: left center, right center, left center, right center;
            background-repeat: no-repeat;
            background-size: 20px 100%, 20px 100%, 10px 100%, 10px 100%;
            background-attachment: local, local, scroll, scroll;
        }


        .node {
            cursor: default;
        }

        .node-rect {
            fill: #f8f8f8;
            stroke: #999;
            stroke-width: 1px;
        }

        .node-rect.node-established {
            stroke: #2e7d32;
            stroke-width: 2px;
        }

        .node-rect.node-recent {
            stroke: #e65100;
            stroke-width: 2px;
            stroke-dasharray: 4 2;
        }

        .node-header {
            pointer-events: none;
        }

        .node-name {
            font-family: sans-serif;
            font-size: 12px;
            font-weight: bold;
            fill: white;
            pointer-events: none;
        }

        .node-detail {
            font-family: sans-serif;
            font-size: 11px;
            fill: #333;
        }

        .node-variant-link {
            font-family: sans-serif;
            font-size: 11px;
            fill: #0077b6;
            text-decoration: underline;
            cursor: pointer;
        }

        .node-variant-link:hover {
            fill: #023e8a;
        }

        .node-date {
            font-size: 10px;
            fill: #666;
        }

        .link {
            fill: none;
            stroke: #999;
            stroke-width: 1.5px;
        }

        .breadcrumb-item + .breadcrumb-item::before {
            content: ">"
        }
</style>
